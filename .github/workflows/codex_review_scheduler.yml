name: Scheduled Codex reviews for Jules PRs

on:
  schedule:
    - cron: "0 12,17,22 * * *"  # 09:00,14:00,19:00 Sao Paulo (UTC-3)
  workflow_dispatch: {}

permissions:
  pull-requests: read
  issues: read
  actions: write

concurrency:
  group: codex-jules-review-scheduler
  cancel-in-progress: true

jobs:
  sweep:
    runs-on: ubuntu-latest
    steps:
      - name: Find open Jules PRs without codex-reviewed label
        id: find
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const q = `repo:${context.repo.owner}/${context.repo.repo} is:pr is:open author:google-labs-jules -label:codex-reviewed`;
            const res = await github.rest.search.issuesAndPullRequests({ q, per_page: 50 });
            const prs = res.data.items.map(i => i.number);
            core.setOutput("prs", JSON.stringify(prs));

      - name: Dispatch Codex review workflow (one dispatch per PR)
        if: ${{ fromJSON(steps.find.outputs.prs).length > 0 }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const prs = JSON.parse(process.env.PRS_JSON);
            for (const pr of prs) {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: "codex_review_for_jules_prs.yml",
                // schedule runs on the default branch; context.ref is refs/heads/<branch>
                ref: context.ref.replace("refs/heads/", ""),
                inputs: { pr_number: String(pr) }
              });
            }
        env:
          PRS_JSON: ${{ steps.find.outputs.prs }}
