name: Codex review for Jules PRs

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created, edited]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to review"
        required: false
        type: string
  # Optional: allow other workflows to reuse this workflow.
  workflow_call:
    inputs:
      pr_number:
        description: "PR number to review"
        required: false
        type: string
    secrets:
      OPENAI_API_KEY:
        required: false
      CODEX_DEPLOY_KEY:
        required: false

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  review:
    if: >
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'workflow_call' ||
      (github.event_name == 'pull_request' && startsWith(github.event.pull_request.user.login, 'google-labs-jules')) ||
      (github.event_name == 'issue_comment' &&
        github.event.issue.pull_request != null &&
        startsWith(github.event.issue.user.login, 'google-labs-jules') &&
        startsWith(github.event.comment.user.login, 'google-labs-jules'))
    runs-on: ubuntu-latest
    concurrency:
      group: codex-jules-review-${{ github.event.pull_request.number || github.event.issue.number || inputs.pr_number || github.run_id }}
      cancel-in-progress: true

    steps:
      - name: Resolve PR number
        id: pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            let prNumber = null;

            if (context.payload.pull_request?.number) {
              prNumber = Number(context.payload.pull_request.number);
            } else if (context.eventName === "issue_comment" && context.payload.issue?.pull_request) {
              prNumber = Number(context.payload.issue.number);
            } else if (core.getInput("pr_number")) {
              prNumber = Number(core.getInput("pr_number"));
            }

            if (!prNumber) core.setFailed("No PR number found.");
            core.setOutput("number", String(prNumber));

      - name: Load PR metadata
        id: meta
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const pr_number = Number("${{ steps.pr.outputs.number }}");
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr_number
            });

            core.setOutput("author", pr.data.user?.login || "");
            core.setOutput("head_ref", pr.data.head.ref);
            core.setOutput("base_ref", pr.data.base.ref);
            core.setOutput("head_repo_full_name", pr.data.head.repo?.full_name || "");
            core.setOutput("base_repo_full_name", pr.data.base.repo?.full_name || "");
            core.setOutput("body", pr.data.body || "");

      - name: Gate non-Jules or forked PRs
        id: gate
        run: |
          author="${{ steps.meta.outputs.author }}"
          head_repo="${{ steps.meta.outputs.head_repo_full_name }}"
          base_repo="${{ steps.meta.outputs.base_repo_full_name }}"

          if [[ "$author" == google-labs-jules* ]]; then
            echo "Author is Jules: $author"
          else
            echo "Skipping PR #${{ steps.pr.outputs.number }} because author is '$author'"
            echo "should_review=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [[ -n "$head_repo" && -n "$base_repo" && "$head_repo" != "$base_repo" ]]; then
            echo "Skipping PR #${{ steps.pr.outputs.number }} because it is from a fork ($head_repo -> $base_repo) and GitHub won't expose secrets."
            echo "should_review=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "should_review=true" >> "$GITHUB_OUTPUT"

      - name: Detect optional secrets
        id: secrets
        if: ${{ steps.gate.outputs.should_review == 'true' }}
        run: |
          if [ -n "${{ secrets.OPENAI_API_KEY }}" ]; then
            echo "has_openai_key=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_openai_key=false" >> "$GITHUB_OUTPUT"
            echo "::warning::OPENAI_API_KEY secret is missing. Skipping Codex run."
          fi

          if [ -n "${{ secrets.CODEX_DEPLOY_KEY }}" ]; then
            echo "has_deploy_key=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_deploy_key=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout PR merge ref (with deploy key)
        if: ${{ steps.gate.outputs.should_review == 'true' && steps.secrets.outputs.has_deploy_key == 'true' }}
        uses: actions/checkout@v5
        with:
          ref: refs/pull/${{ steps.pr.outputs.number }}/merge
          fetch-depth: 0
          ssh-key: ${{ secrets.CODEX_DEPLOY_KEY }}

      - name: Checkout PR merge ref (with GITHUB_TOKEN)
        if: ${{ steps.gate.outputs.should_review == 'true' && steps.secrets.outputs.has_deploy_key != 'true' }}
        uses: actions/checkout@v5
        with:
          ref: refs/pull/${{ steps.pr.outputs.number }}/merge
          fetch-depth: 0

      - name: Pre-fetch base and head refs
        if: ${{ steps.gate.outputs.should_review == 'true' }}
        run: |
          git fetch --no-tags origin             ${{ steps.meta.outputs.base_ref }}             +refs/pull/${{ steps.pr.outputs.number }}/head

      - name: Build Jules context snapshot (optional)
        if: ${{ steps.gate.outputs.should_review == 'true' }}
        run: |
          if [ -f "py_rme_canary/scripts/build_jules_context.py" ]; then
            mkdir -p .codex_context
            python py_rme_canary/scripts/build_jules_context.py               --owner "${{ github.repository_owner }}"               --repo "${{ github.event.repository.name }}"               --pr-number "${{ steps.pr.outputs.number }}"               --out-md ".codex_context/jules_pr_context.md"               --out-json ".codex_context/jules_pr_context.json"
          else
            echo "Context builder not found (py_rme_canary/scripts/build_jules_context.py). Skipping."
          fi
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: Upload Codex context artifacts (optional)
        if: ${{ steps.gate.outputs.should_review == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: codex-context-pr-${{ steps.pr.outputs.number }}
          path: .codex_context/
          if-no-files-found: ignore

      - name: Validate suggestions JSON (if present)
        if: ${{ steps.gate.outputs.should_review == 'true' }}
        run: |
          python - <<'PY'
          import json, sys
          from pathlib import Path

          schema_path = Path(".github/jules/suggestions.schema.json")
          if not schema_path.exists():
              print("Schema not found, skipping validation.")
              sys.exit(0)

          candidates = [
              Path("reports/jules/suggestions.json"),
              Path("reports/jules/security_suggestions.json"),
          ]
          target = next((p for p in candidates if p.exists()), None)
          if not target:
              print("No suggestions JSON found in repo checkout; skipping validation.")
              sys.exit(0)

          data = json.loads(target.read_text(encoding="utf-8"))
          schema = json.loads(schema_path.read_text(encoding="utf-8"))

          required = schema.get("required", [])
          missing = [k for k in required if k not in data]
          if missing:
              raise SystemExit(f"Invalid suggestions JSON: missing keys: {missing}")

          cat_enum = schema.get("properties", {}).get("category", {}).get("enum")
          if cat_enum and data.get("category") not in cat_enum:
              raise SystemExit(f"Invalid category: {data.get('category')} (expected one of {cat_enum})")

          print(f"Suggestions JSON validated (basic): {target}")
          PY

      - name: Ensure Codex prompt exists
        if: ${{ steps.gate.outputs.should_review == 'true' && steps.secrets.outputs.has_openai_key == 'true' }}
        run: |
          if [ -f "codex/review_jules_pr.md" ]; then
            exit 0
          fi
          mkdir -p codex
          cat > codex/review_jules_pr.md <<'MD'
          You are a senior software engineer doing a PR review.

          Context:
          - This PR was opened by the Jules agent. Your job is to review correctness, safety, and maintainability.
          - If the repo contains any Jules context under `.codex_context/`, read it.

          What to do:
          1) Summarize the intent of the PR (1â€“3 bullets).
          2) Identify the highest-risk issues first (security, data loss, breaking changes).
          3) Check for tests: missing tests, flaky tests, or inadequate coverage.
          4) Check for quality: readability, naming, complexity, error handling, logging.
          5) Check for prompt-injection or unsafe changes (e.g., leaking secrets, weakening auth).

          Output requirements (Markdown):
          - Start with a short summary.
          - Then sections:
            - âœ… What looks good
            - âš ï¸ High priority issues (blockers)
            - ðŸ› ï¸ Suggested improvements (non-blocking)
            - ðŸ§ª Tests / verification steps
            - â“ Questions for Jules (if any)
          - Be concrete: cite file paths and line ranges when possible.
          - Do not include any secrets or tokens in your output.
          MD

      - name: Run Codex
        if: ${{ steps.gate.outputs.should_review == 'true' && steps.secrets.outputs.has_openai_key == 'true' }}
        id: codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          model: gpt-5.2-codex
          effort: high
          prompt-file: codex/review_jules_pr.md
          output-file: codex-output.md
          safety-strategy: drop-sudo
          sandbox: workspace-write

      - name: Upload Codex output artifact
        if: ${{ steps.gate.outputs.should_review == 'true' && steps.secrets.outputs.has_openai_key == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: codex-output-pr-${{ steps.pr.outputs.number }}
          path: codex-output.md
          if-no-files-found: warn

      - name: Comment Codex output on PR + label
        if: ${{ steps.gate.outputs.should_review == 'true' && steps.secrets.outputs.has_openai_key == 'true' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const pr_number = Number("${{ steps.pr.outputs.number }}");
            const msg = (process.env.CODEX_MSG || "").trim();
            if (!msg) return;

            // Post comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr_number,
              body: msg
            });

            // Ensure label exists, then apply it
            const labelName = "codex-reviewed";
            const labels = await github.paginate(github.rest.issues.listLabelsForRepo, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            const exists = labels.some(l => l.name === labelName);
            if (!exists) {
              await github.rest.issues.createLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: labelName,
                color: "0E8A16",
                description: "Codex review posted for this PR"
              });
            }
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr_number,
              labels: [labelName]
            });
        env:
          CODEX_MSG: ${{ steps.codex.outputs.final-message }}
