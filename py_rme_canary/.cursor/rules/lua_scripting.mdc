description: "Padrões de scripting Lua modernos (Revscriptsys) e OOP para OpenTibia" globs: "data/scripts//*.lua, data/lib//*.lua" alwaysApply: false

OpenTibia Lua & Revscriptsys Guidelines

Esta regra impõe o uso de Revscriptsys e Orientação a Objetos (OOP), eliminando dependências de arquivos XML antigos (actions.xml, movements.xml, etc).

1. Mandato Revscriptsys

Proibido: Editar arquivos XML para registrar scripts.

Obrigatório: Scripts devem ser auto-registráveis e colocados em data/scripts/.

2. Padrões de Registro

Use os construtores de objetos Lua. Evite variáveis globais soltas.

Action (Clique/Uso)

local myAction = Action()

function myAction.onUse(player, item, fromPosition, target, toPosition, isHotkey)
    if not target or not target:isItem() then
        return false -- Retorna false para permitir comportamento padrão do item
    end
    
    player:sendTextMessage(MESSAGE_INFO_DESCR, "Você usou o item!")
    return true
end

-- Seletores
myAction:id(2160) -- Crystal Coin
-- OU
myAction:aid(4500) -- Action ID
myAction:register()


MoveEvent (Movimento)

local myTile = MoveEvent()

function myTile.onStepIn(creature, item, position, fromPosition)
    if not creature:isPlayer() then
        return true
    end
    
    creature:teleportTo(fromPosition, true)
    return true
end

myTile:type("stepin")
myTile:aid(45000)
myTile:register()


3. Gerenciamento de Estado (OOP)

Para sistemas complexos (Dungeons, Bosses), use metatables em data/lib/.

-- data/lib/core/dungeon.lua
Dungeon = {
    interval = 1000
}
Dungeon.__index = Dungeon

function Dungeon.new(name)
    local self = setmetatable({}, Dungeon)
    self.name = name
    self.players = {}
    return self
end

function Dungeon:addPlayer(player)
    table.insert(self.players, player:getId())
end


4. Erros Comuns (Pitfalls)

Closures em addEvent

O objeto Player (userdata) torna-se inválido (dangling pointer no C++) se o jogador deslogar antes do evento disparar.

-- BAD: Crash potencial se o player deslogar
addEvent(function() player:sendTextMessage(...) end, 1000)

-- GOOD: Passar ID e revalidar
addEvent(function(cid)
    local p = Game.getPlayer(cid)
    if p then p:sendTextMessage(...) end
end, 1000, player:getId())
