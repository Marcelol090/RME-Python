description: "Technical specification for OTBM binary map parsing and manipulation" globs: "/*.otbm, tools//.py, src/**/iomap" alwaysApply: falseOTBM (OpenTibia Binary Map) SpecificationReferência técnica para parsers, ferramentas de edição e I/O de mapas.1. Node Hierarchy & Hex CodesO mapa é uma árvore N-ária. Todo nó inicia com um byte identificador (Type).Node NameHexDescriptionOTBM_ROOTV10x00Legacy header (Raro).OTBM_MAP_DATA0x02Raiz padrão. Contém atributos globais (Width, Height).OTBM_TILE_AREA0x04Agrupador espacial. Define Base X, Y para filhos.OTBM_TILE0x05Tile individual. Define Offset X, Y relativo à área.OTBM_ITEM0x06Item (pode conter outros itens/containers).OTBM_TOWNS0x0CDefinição de cidades.2. Serialization Protocol (Little Endian)A estrutura de um nó é sempre:[StartNode] [Type] [Attributes] [Children...] [EndNode]Start Node: 0xFDEnd Node: 0xFEEscape Char: 0xFD, 0xFE e 0xFF devem ser escapados se aparecerem em dados (strings/nomes), precedidos por 0xFF.3. Coordinate System CalculationA otimização espacial do OTBM usa coordenadas relativas para economizar bytes:TileArea: Define BaseX (uint16) e BaseY (uint16).Tile: Define OffsetX (uint8) e OffsetY (uint8).Real Position:Pos.x = TileArea.BaseX + Tile.OffsetXPos.y = TileArea.BaseY + Tile.OffsetYPos.z é definido no cabeçalho da TileArea.4. Python Implementation Reference (struct)Ao criar ferramentas em Python para ler OTBM:import struct

# Sempre usar Little Endian (<)
# H = unsigned short (2 bytes), B = unsigned char (1 byte)

def parse_tile_area_header(data):
    # Formato: BaseX, BaseY, Z
    return struct.unpack('<HHB', data[0:5])

def parse_item_attribute(flag, data_stream):
    if flag == 0x01: # OTBM_ATTR_COUNT
        return struct.unpack('B', data_stream.read(1))[0]
    # ... outros atributos
